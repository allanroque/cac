---
- name: Coletar informações de CPU e Memória
  hosts: windows
  gather_facts: false  # Desligar coletar informações do sistema

  tasks:
##############################################
#### Informacao consumo de cpu e memoria #####
##############################################
    - name: Obter informações de CPU e Memória
      win_shell: |
        $cpuUsage = Get-Counter -Counter '\Processor(_Total)\% Processor Time' -SampleInterval 1 -MaxSamples 1 | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
        $memoryInfo = Get-CimInstance -ClassName Win32_OperatingSystem
        $memoryUsed = $memoryInfo.TotalVisibleMemorySize - $memoryInfo.FreePhysicalMemory
        $memoryUsage = [math]::Round(($memoryUsed / $memoryInfo.TotalVisibleMemorySize) * 100, 2)

        $info = @{
          cpu_usage_percent = $cpuUsage
          memory_usage_percent = $memoryUsage
        }

        $infoJson = $info | ConvertTo-Json
        Write-Host $infoJson
      register: system_info
      changed_when: false

    - name: Extrair informações de CPU e Memória
      set_fact:
        system_info_json: "{{ system_info.stdout }}"
        memory_usage_percent: "{{ (system_info.stdout | from_json).memory_usage_percent }}"

    - name: Exibir informações de Memória
      debug:
        var: memory_usage_percent
